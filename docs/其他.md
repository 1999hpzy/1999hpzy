# 其他, 大杂烩

## 小数二进制表示

十进制的小数转换为二进制小数，主要是利用小数部分乘2，取整数部分，直至小数点后为0。

以 0.625 为例：

| 步骤 | 0.625 | 十进制转二进制 |
| -- | -- | -- |
| 1 | 0.625 * 2 = 1.25 | 整数部分取 1, 余 0.25 |
| 2 | 0.25 * 2 = 0.5 | 整数部分没有 0, 余 0.5 |
| 3 | 0.5 * 2 = 1.0 | 整数部分取 1, 余 0.0 |

需要注意的是，如果尾数不是 0 或 5（比如 9.624），就无法用一个二进制数来精确表达。因此一些编程语言/数据库中的 浮点类型数据 会有不准确的问题。

```sh
~] echo 'obase=2;0.625' | bc
.1010000000

~] echo 'obase=2;0.624' | bc
.1001111110
```

## `sshpass` 常见用法

```sh
sshpass -p123456 ssh-copy-id -i ~/.ssh/id_rsa.pub " root@172.16.1.$ip  -o StrictHostKeyChecking=no "
sshpass -p123qweQ ssh root@192.168.163.241 'ls /root'
sshpass -f ~/password ssh root@192.168.163.241 'ls /root'
sshpass -p123qweQ scp -o StrictHostKeyChecking=no root@192.168.1.12:/tmp/testfile /root/
sshpass -p123qweQ ssh -o StrictHostKeyChecking=no root@192.168.1.103 "lsblk "
```

## 红帽订阅管理

### 注册

```bash
# 将系统注册到rhn（输入用户名和密码）
subscription-manager register

# 列出系统所有可用的订阅，并记录你在系统激活的订阅池Id
subscription-manager list --available --all

# 使用订阅池id激活订阅
subscription-manager attach --pool=8a85f98154ef8eb40154f1b1d3620670

# 关闭系统所有仓库
subscription-manager repos --disable="*"

# 仅打开系统 server 仓库。
subscription-manager repos --enable=rhel-7-server-rpms

# 列出系统所有仓库。
yum repolist

# 如果需要重新注册，执行以下命令组
sudo subscription-manager remove --all
sudo subscription-manager unregister
sudo subscription-manager clean
sudo subscription-manager register
sudo subscription-manager refresh
sudo subscription-manager attach --auto
```

### 使用

* 用于正常安装软件、补丁等
* 同步补丁，用于搭建补丁源

    ```sh
    # 缓存少量指定包
    yum install ntp --downloadonly --downloaddir=/tmp/

    # 同步整个 repo
    # 7.x 及以下版本
    reposync --plugins --newest-only --delete --download_path=<download_path> --repoid=<repo_id>
    # 8.x 版本
    dnf reposync --newest-only --delete --download-metadata --download-path=<download_path> --repoid=<repo_id>
    ```


### 附A: 关于repodata

* `repodata/` 目录下的文件信息

    执行 `createrepo` 会在当前目录下生成一个 `repodata` 的文件夹, 里面一般有以下几个文件:

    - `primary.xml.gz`: 包含所有rpm文件列表、依赖关系、软件包安装列表 
    - `filelists.xml.gz`: 包含所有rpm包的配置文件列表  
    - `other.xml.gz`: 包含软件包其他信息，比如更改记录  
    - `comps.xml`: 包含软件包组的列表，控制软件包 `group` 安装  
    - `repomd.xml`: 包含 `primary`/`filelist`/`other` 文件的时间戳、检验等等之类   

* `yum` 安装 rpm 包执行过程

    - (1) 在 `primary.xml` 里找到需要安装的包  
    - (2) 在 `primary.xml` 中获取到安装包完整名词和依赖包列表  
    - (3) 在 `primary.xml` 中根据 `<location href=xxx/>`获取安装包路径
    - (4) 在 `primary.xml` 中获取依赖包名和对应的 `pkgid`，并在 `filelists.xml` 中获取到配置文件
    - (5) 根据已有信息获取 rpm 包并安装  

* `repodata` 中的 "路径问题"

    首先，有以下三点说明:

    * `yum` 读取 `repodata/primary.xml` 中记录的 `<location href=/>` 时，是以 `repodata` 目录所在那一级目录为基准点的（相对路径），而执行 `createrepo` 命令生成 `repodata` 的所在目录以及 `primary.xml`，是由我们指定的路径决定的。

    * `createrepo` 默认在当前目录下生成 `repodata/` 目录, 可通过 `-o` 指定

    * yum 源 `repo` 文件中配置项 `baseurl` : Must be a URL to the directory where the yum repository's *repodata* directory lives. Can be an ++http://++, ++ftp://++ or ++file://++ URL.

    综上三点可知：

    * 执行 `yum` 安装 `rpm` 包时，获取实际 `rpm` 包的路径为

        ```
        "repo 文件中配置项 baseurl 的路径"/"primary.xml 中 <location href=xxx> 记录的路径"
        ```

        例如: 下面这种情况下，yum 安装 rpm 包时会以 `/media/t/tree-1.6.0-10.el7.x86_64.rpm` 这个路径下载 `tree`
        
        ```
        ~] cat /etc/yum.repos.d/media.repo
        ...
        baseurl=/media/
        ...

        ~] ls /media
        ...
        repodata/
        ...

        ~] cat /media/repodata/xxxxx...primary.xml
        ...
        <location href="t/tree-1.6.0-10.el7.x86_64.rpm">
        ...
        ```

* `createrepo` 的路径问题

    ```sh
    ~] tree /media/
    .
    └── Packages
        └── dir1
            ├── x1.rpm
            ├── ...
            └── xn.rpm
    ```
    
    * 情景一

        ```sh
        ~] cd /media
        ~] createrepo /media/Packages
        ~] tree /media
        .
        ├── Packages
        |   └── dir1
        |       ├── x1.rpm
        |       ├── ...
        |       └── xn.rpm
        └── repodata
            ├── ...primary.xml.gz
            ├── ...
            └── repomd.xml

        ~] gzip -d /media/repodata/primary.xml -c | grep 'location href'
        <location href="dir1/x1.rpm"/>
        <location href="dir1/x2.rpm"/>
        ...
        <location href="dir1/xn.rpm"/>
        ```

    * 情景二

        ```sh
        ~] cd /media
        ~] createrepo /media/
        ~] tree /media
        .
        ├── Packages
        |   └── dir1
        |       ├── x1.rpm
        |       ├── ...
        |       └── xn.rpm
        └── repodata
            ├── ...primary.xml.gz
            ├── ...
            └── repomd.xml

        ~] gzip -d /media/repodata/primary.xml -c | grep 'location href'
        <location href="Packages/dir1/x1.rpm"/>
        <location href="Packages/dir1/x2.rpm"/>
        ...
        <location href="Packages/dir1/xn.rpm"/>
        ```

    以上两种情景，repo 配置文件中 baseurl 都应该配置为 baseurl=file:///mnt，安装 x1.rpm 时，搜索路径为

    ```text
        情景一： /media/dir1/x1.rpm          # 异常
        情景一： /media/Packages/dir1/x1.rpm # 正常
    ```
    
    综上，使用 `createrepo` 的最佳实践为:  

    ```bash
    createrepo /path/of/package -o /path/of/package
    # 或
    createrepo .
    ```