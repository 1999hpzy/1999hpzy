# 性能


## 进程优先级

MAX_PRIO = 140
MAX_PRIO = MAX_RT_PRIO + NICE_WIDTH

MAX_RT_PRIO: 描述实时进程 (Realtime) 优先级范围
NICE_WIDTH: 描述 NICE 取值范围


```c
#define DEFAULT_PRIO            (MAX_RT_PRIO + NICE_WIDTH / 2)
```

所有进程优先级范围：0~139

实时进程：0~99 (可使用 `chrt` 查看,调整,设置)

非实时进程（用户进程）：100~139 (可使用 `nice`/`renice` 调整, 取值范围 [-20, 19])


```sh
# 启动进程时设置进程 NI 值
nice -n N <COMMAND...>

# 调整已运行进程的 NI 值
renice -n N <PID>

# 查看进程 NI 值和 PRI 值
~] ps -elf | head 
F S UID        PID  PPID  C PRI  NI ADDR SZ WCHAN  STIME TTY          TIME CMD
4 S root         1     0  0  80   0 - 32002 ep_pol Jun18 ?        00:00:23 /usr/lib/systemd/systemd --switched-root --system --deserialize 22
1 S root         2     0  0  80   0 -     0 kthrea Jun18 ?        00:00:00 [kthreadd]
1 S root         3     2  0  80   0 -     0 smpboo Jun18 ?        00:00:00 [ksoftirqd/0]
1 S root         5     2  0  60 -20 -     0 worker Jun18 ?        00:00:00 [kworker/0:0H]
1 S root         7     2  0 -40   - -     0 smpboo Jun18 ?        00:00:00 [migration/0]
1 S root         8     2  0  80   0 -     0 rcu_gp Jun18 ?        00:00:00 [rcu_bh]
1 R root         9     2  0  80   0 -     0 -      Jun18 ?        00:00:03 [rcu_sched]
1 S root        10     2  0  60 -20 -     0 rescue Jun18 ?        00:00:00 [lru-add-drain]
5 S root        11     2  0 -40   - -     0 smpboo Jun18 ?        00:00:15 [watchdog/0]

# top 查看 NI 和 PR
# 
~] top
  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND    
    1 root      20   0  128008   4136   2472 S  0.0  0.4   0:23.51 systemd      
    2 root      20   0       0      0      0 S  0.0  0.0   0:00.10 kthreadd     
    3 root      20   0       0      0      0 S  0.0  0.0   0:00.57 ksoftirqd/0  
    5 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kworker/0:0H 
    7 root      rt   0       0      0      0 S  0.0  0.0   0:00.00 migration/0  
    8 root      20   0       0      0      0 S  0.0  0.0   0:00.00 rcu_bh       
    9 root      20   0       0      0      0 S  0.0  0.0   0:03.61 rcu_sched    
   10 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 lru-add-drain
```

PRI 代表 Priority (动态优先级), NI 代表 Nice (静态优先级). PRI 和 NI 的关系如下：

```sh
PRI (最终值) = PRI (原始值) + NI

# NI 取值范围: root [-20, 19], 普通用户 [0, 19]
# 
```

进程的 PRI 值越小, 优先级越高; 进程 NI 越小, 其 PRI 值就越小, 优先级越高


10.2.99.120

10.2.99.117



## mpstat

```text
%user      在internal时间段里, 用户态的CPU时间(%), 不包含nice值为负进程  (usr/total)*100
%nice      在internal时间段里, nice值为负进程的CPU时间(%)   (nice/total)*100
%sys       在internal时间段里, 内核时间(%)       (system/total)*100
%iowait    在internal时间段里, 硬盘IO等待时间(%) (iowait/total)*100
%irq       在internal时间段里, 硬中断时间(%)     (irq/total)*100
%soft      在internal时间段里, 软中断时间(%)     (softirq/total)*100
%idle      在internal时间段里, CPU除去等待磁盘IO操作外的因为任何原因而空闲的时间闲置时间(%) (idle/total)*100
```

## top

### 1 表头信息详解

```text
## 系统整体情况概览
top - 12:05:07 up  1:16,  2 users,  load average: 1.77, 1.38, 1.24
      | 时间 | 运行时间 |当前登录用户|平均负载: 1分钟/5分钟/15分钟均值|
                                    即任务队列的平均长度
```

```text
## 进程状态
Tasks: 215 total,   1 running, 213 sleeping,   1 stopped,   0 zombie
      | 总任务  |      运行中 |     休眠状态 |   停止状态 |   僵尸进程 |
```

```text
## CPU
%Cpu(s):  7.4 us,  5.2 sy,  0.0 ni, 87.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
       | 用户空间|内核空间| 优先级调|   空闲 |  IO等待 |  硬中断 | 软中断 | steal |
                          整耗时(用户空间)                               虚拟机调度/申请等花费
```

```text
## 内存, SWAP信息
KiB Mem : 32780168 total, 25278248 free,  2334020 used,  5167900 buff/cache
单位   |  总容量         |         空闲 |       已使用 |               缓存 |

KiB Swap:  4063228 total,  4063228 free,        0 used. 25974516 avail Mem
单位   |  总容量         |         空闲 |       已使用 |
```


### 2 进程状态

```text
## 进程状态
    PID USER        PR        NI     VIRT     RES      SHR S          %CPU     %MEM         TIME+ COMMAND                                                                                                
   4708 qemu        20         0  4424784  342904    21752 S           5.9      1.0     286:49.77 qemu-kvm
      3 root         0       -20        0       0        0 I           0.0      0.0       0:00.00 rcu_gp  
PID |进程用户|动态优先级|静态优先级|虚拟内存|物理内存|共享内存|进程状态|CPU占用| 内存占用| 占用CPU总时间|进程命令描述
              Priority      nice      KB      KB      KB  R=运行               %RES
                                                          S=睡眠
                                                          T=跟踪/停止
                                                          D=不可中断的睡眠状态 
                                                          Z=僵尸进程
```

扩展: 全部列

```text
Fields Management for window 1:Def, whose current sort field is %CPU
   Navigate with Up/Dn, Right selects for move then <Enter> or Left commits,
   'd' or <Space> toggles display, 's' sets sort.  Use 'q' or <Esc> to end!
* PID     = Process Id             DATA    = Data+Stack (KiB)    
* USER    = Effective User Name    nMaj    = Major Page Faults   
* PR      = Priority               nMin    = Minor Page Faults   
* NI      = Nice Value             nDRT    = Dirty Pages Count   
* VIRT    = Virtual Image (KiB)    WCHAN   = Sleeping in Function
* RES     = Resident Size (KiB)    Flags   = Task Flags <sched.h>
* SHR     = Shared Memory (KiB)    CGROUPS = Control Groups      
* S       = Process Status         SUPGIDS = Supp Groups IDs     
* %CPU    = CPU Usage              SUPGRPS = Supp Groups Names   
* %MEM    = Memory Usage (RES)     TGID    = Thread Group Id     
* TIME+   = CPU Time, hundredths   OOMa    = OOMEM Adjustment    
* COMMAND = Command Name/Line      OOMs    = OOMEM Score current 
  PPID    = Parent Process pid     ENVIRON = Environment vars    
  UID     = Effective User Id      vMj     = Major Faults delta  
  RUID    = Real User Id           vMn     = Minor Faults delta  
  RUSER   = Real User Name         USED    = Res+Swap Size (KiB) 
  SUID    = Saved User Id          nsIPC   = IPC namespace Inode 
  SUSER   = Saved User Name        nsMNT   = MNT namespace Inode 
  GID     = Group Id               nsNET   = NET namespace Inode 
  GROUP   = Group Name             nsPID   = PID namespace Inode 
  PGRP    = Process Group Id       nsUSER  = USER namespace Inode
  TTY     = Controlling Tty        nsUTS   = UTS namespace Inode 
  TPGID   = Tty Process Grp Id     LXC     = LXC container name  
  SID     = Session Id             RSan    = RES Anonymous (KiB) 
  nTH     = Number of Threads      RSfd    = RES File-based (KiB)
  P       = Last Used Cpu (SMP)    RSlk    = RES Locked (KiB)    
  TIME    = CPU Time               RSsh    = RES Shared (KiB)    
  SWAP    = Swapped Size (KiB)     CGNAME  = Control Group name  
  CODE    = Code Size (KiB)        NU      = Last Used NUMA node 
```


### 3 快捷键

```text
space  立即刷新
h  帮助
q  退出

0  值为0的不显示
1  显示CPU各个核心的信息
2  显示CPU各个核心的信息

l  切换表头 负载信息 显示模式(开/关)
t  切换表头 CPU 显示模式
m  切换表头 内存/SWAP 显示模式

E  切换表头内存/SWAP显示单位
e  切换 VIRT, RES, SHR 显示单位

H  显示线程信息而不是进程信息

c  显示 命令名称/完整命令(COMMAND)
i  显示/不显示 任何闲置或者僵死(idle)的进程

P  按 CPU 使用率从大到小排序
M  按 内存 使用率从大到小排序
N  按 PID 号从大到小排序
T  按 TIME+ 从大到小排序
R  切换排序规则(从大到小, 从小到大)
xb 高亮显示当前排序列

d,s  设置更新间隔(s)
k  kill 终止进程
r  renice 修改进程 nice 值

f,F 添加/删除显示的列; 设置排序的列
    按 f 进入字段选择界面
    按 ↑, ↓ 选择字段
        按 s 选择排序的列
        按 → 选中字段, 然后按 ↑, ↓ 来移动字段显示
        按 d 或者 space 来取消/显示字段
    按 q 回到主界面查看排序

W  保存当前配置到文件中, 下次启动 `top` 时会使用此配置

L   查找, 使用 `&` 查找下一个
u,U 只显示指定用户的进程; 按 = 键取消过滤条件
o,O 过滤, o 忽略大小写; O 大小写敏感; 按 = 键取消过滤条件
    +------------------------------------------------+
    |   #1           #2  #3              ( required )|
    |   Field-Name   ?   include-if-value            |
    |!  Field-Name   ?   exclude-if-value            |
    |#4                                  ( optional )|
    +------------------------------------------------+
    #2: 运算符号, 只能是 +, >, <
        =: 部分匹配即可
        >, <: 使用字符串比较, 即使是数字字段(实测:纯数字字段课使用算术比较)
    例:
        查找命令中含 systemd 的进程: COMMAND=systemd
        查找 CPU 占用超过 1% 的进程: %CPU>1.0
ctrl+o 查看当前的过滤条件

I  开启/关闭 Irix mode(默认开启)
    Irix mode: 计算占总CPU的百分比, 可能会超过100%, 但不会超过 核数*100%
    Solaris mode: 计算分摊到所有CPU的平均百分比, 总的CPU百分比/核数

V  树形显示
z  彩色显示
b  切换高亮选中
```



### 5 `h` 帮助页面

* 交互命令

```text
Help for Interactive Commands - procps-ng 3.3.15
Window 1:Def: Cumulative mode Off.  System: Delay 3.0 secs; Secure mode Off.

  Z,B,E,e   Global: 'Z' colors; 'B' bold; 'E'/'e' summary/task memory scale
  l,t,m     Toggle Summary: 'l' load avg; 't' task/cpu stats; 'm' memory info
  0,1,2,3,I Toggle: '0' zeros; '1/2/3' cpus or numa node views; 'I' Irix mode
  f,F,X     Fields: 'f'/'F' add/remove/order/sort; 'X' increase fixed-width

  L,&,<,> . Locate: 'L'/'&' find/again; Move sort column: '<'/'>' left/right
  R,H,V,J . Toggle: 'R' Sort; 'H' Threads; 'V' Forest view; 'J' Num justify
  c,i,S,j . Toggle: 'c' Cmd name/line; 'i' Idle; 'S' Time; 'j' Str justify
  x,y     . Toggle highlights: 'x' sort field; 'y' running tasks
  z,b     . Toggle: 'z' color/mono; 'b' bold/reverse (only if 'x' or 'y')
  u,U,o,O . Filter by: 'u'/'U' effective/any user; 'o'/'O' other criteria
  n,#,^O  . Set: 'n'/'#' max tasks displayed; Show: Ctrl+'O' other filter(s)
  C,...   . Toggle scroll coordinates msg for: up,down,left,right,home,end

  k,r       Manipulate tasks: 'k' kill; 'r' renice
  d or s    Set update interval
  W,Y       Write configuration file 'W'; Inspect other output 'Y'
  q         Quit
          ( commands shown with '.' require a visible task display window ) 
Press 'h' or '?' for help with Windows,
Type 'q' or <Esc> to continue 
```

* 窗口设置

```text
Help for Windows / Field Groups - "Current Window" =  1:Def 

. Use multiple windows, each with separate config opts (color,fields,sort,etc)
. The 'current' window controls the Summary Area and responds to your Commands
  . that window's task display can be turned Off & On, growing/shrinking others
  . with NO task display, some commands will be disabled ('i','R','n','c', etc)
    until a different window has been activated, making it the 'current' window
. You change the 'current' window by:  1) cycling forward/backward; 2) choosing
  a specific field group; or 3) exiting the color mapping or fields screens
. Commands available anytime   -------------
    A       . Alternate display mode toggle, show Single / Multiple windows
    g       . Choose another field group and make it 'current', or change now
              by selecting a number from:  1 =Def; 2 =Job; 3 =Mem; or 4 =Usr
. Commands requiring 'A' mode  -------------
    G       . Change the Name of the 'current' window/field group
 *  a , w   . Cycle through all four windows:  'a' Forward; 'w' Backward
 *  - , _   . Show/Hide:  '-' Current window; '_' all Visible/Invisible
  The screen will be divided evenly between task displays.  But you can make
  some larger or smaller, using 'n' and 'i' commands.  Then later you could:
 *  = , +   . Rebalance tasks:  '=' Current window; '+' Every window
              (this also forces the current or every window to become visible)

In 'A' mode, '*' keys are your essential commands.  Please try the 'a' and 'w'
commands plus the 'g' sub-commands NOW.  Press <Enter> to make 'Current' 
```




### 附录 A: 理解进程中的缩略词术语

#### 编号

1. 进程及编程

    * `PID` 进程编号
    * `PPID` 父进程编号
    * `PGRP` 进程组编号
    * `TPGID` Tty进程组编号
    * `TGID` 线程组ID

2. 用户及编号

    * `UID` 有效用户编号 （即展示出来的身份有可能不是真实身份）
    * `USER` 有效用户名
    * `RUID` 真实用户编号
    * `RUSER` 真实用户名称
    * `SUID` 已保存的用户编号
    * `SUSER` 已保存的用户名
    * `GID` 有效用户组编号
    * `GROUP` 有效用户组名称
    * `SID` 会话编号（即可以说是用户会话，也可以说是进程的会话）

#### 特性

* `S` 进程状态 Process Status (R,S,D,Z) 等
* `NI` Nice value 友善度，好人值 （人好被插队）默认都是0，范围 [-20, 19]
* `PR` Priority （通过 20 + NI 计算出来的）其跟 NI 值一样的语义，也是友善度。值越低抢占的运行时间越多，其实际优先级就越高 （linux 0-99 的 pr 属性 realtime (rt) 任务，100-139 (PR + 100)属性用户）
* `COMMAND` 进程名或启动的命令行（通过 c命令切换）
* `ENVIRON` 环境变量
* `TTY` 使用的 Tty 没有的话表示为 ? 号。tty 提供交互的输入输出，没有 tty 的进程也就没有标准输入和输出

#### 内存资源

* `CODE` 可执行文件代码段大小即 text resident set(TRS) （KB）
* `DATA` 数据段大小+栈空间大小 即 data resident set (DRS) （KB）
* `RES` Resident Size (KB) 进程占用的实际物理内存大小。对应 %MEM 列。RES = CODE + DATA
* `SHR` Shared Memory (KB) 指明了 VIRT 中有多少是共享内存或库大小。
* `SWAP` Swapped size(KB) 使用的交互分区大小。
* `USED` RES + SWAP 大小
* `VIRT` Virtual Image (KB) 虚拟内存分配大小，包含了其他文件(如代码，共享库，mmap等）映射，交换分区映射的地址区间大小。以虚拟内存的地址空间占用理解就对了，并不能准确反应物理内存的占用。

#### CPU 资源

* `TIME` 进程占用 CPU 时间 (如果使用 S 命令启用累加模式(Cumulative Mode) 则包含其曾经的子进程。
* `TIME+` CPU Time, hundredths 比如 5:29.38 对应的 CPU 时间格式为: minutes:seconds.hundredths
* `%CPU` CPU 使用率
* `P` Last Used Cpu (SMP)

#### 统计数据

* `nTH` Number of Threads 线程数量
* `nDRT` Number of Dirty pages 脏页数量
* `nMaj` Major Page Faults (已请求的内存页还没有被加载，这是主要的应用申请内存产生的请求）
* `nMin` Minor Page Faults (内存页已加载但是没有被MMU管理）
* `namespace` 作为一种用于隔离一组进程的资源手段，
* `nsIPC` IPC namespace Inode （用于隔离IPC）
* `nsMNT` MNT namespace Inode (用于隔离挂载点）
* `nsNET` NET namespace Inode (用于隔离网络栈)
* `nsPID` PID namespace Inode （用于隔离进程编号）
* `nsUSER` USER namespace Inode （用于隔离用户）
* `nsUTS` UTS namespace Inode （用于隔离域名和主机名）